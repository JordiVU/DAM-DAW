package practica1;

import java.io.IOException;
import java.net.URI;
import java.net.URLEncoder;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.nio.charset.StandardCharsets;
import java.time.Duration;
import com.google.gson.JsonArray;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;


public class iTunes {
    public static void peticionITunes(String tituloCancion, String artistaCancion) {
    	HttpClient client = HttpClient.newBuilder() 
    			.version(HttpClient.Version.HTTP_2) 
    			.connectTimeout(Duration.ofSeconds(5)) 
    			.build();
    	
    	String term = tituloCancion + " " + artistaCancion;
    	String url = "https://itunes.apple.com/search?entity=song&limit=1&term=" 
    			+ URLEncoder.encode(term, StandardCharsets.UTF_8);
    	
    	HttpRequest request = HttpRequest.newBuilder() 
    			.uri(URI.create(url)) 
    			.timeout(Duration.ofSeconds(10)) 
    			.header("Accept", "application/json") 
    			.GET() 
    			.build(); 
    	
        try {
	    	HttpResponse<String> response = client.send(request, 
	    	HttpResponse.BodyHandlers.ofString()); 
			int status = response.statusCode(); 
			if (status == 200) { 
			String json = response.body(); 
			// Aquí se parsearía con Gson (fuera del alcance de esta guía) 
			
            JsonObject root = JsonParser.parseString(json).getAsJsonObject();
            JsonArray results = root.getAsJsonArray("results");

            if (results.size() > 0) {
                JsonObject song = results.get(0).getAsJsonObject();

                // 🖼️ Carátula
                String caratula = song.get("artworkUrl100").getAsString();

                // ⭐ Popularidad (puedes usar precio o tiempo de duración)
                double popularidad = song.has("trackPrice") ? song.get("trackPrice").getAsDouble() : 0.0;

                // 🔗 Enlace a iTunes
                String enlace = song.get("trackViewUrl").getAsString();

                System.out.println("📀 Información iTunes:");
                System.out.println("   Carátula: " + caratula);
                System.out.println("   Popularidad: " + popularidad);
                System.out.println("   Enlace: " + enlace);
			} else { 
			System.err.println("HTTP " + status + " -> " + response.body()); 
			}
        } catch (IOException | InterruptedException e) {
            e.printStackTrace();
        }
    }
}
